import numpy as np
import pytest
from numpy.testing import assert_array_almost_equal

from eisplottingtool.parser import parse_circuit

param_values = {
    'R': 1,
    'C': 1,
    'CPE_Q': 1,
    'CPE_n': 0.5,
    'W': 1,
    'Ws_R': 1,
    'Ws_T': 1,
    'Wo_R': 1,
    'Wo_T': 1,
    }

freq = np.array(
        [1000000000.0, 568986602.901831, 323745754.281766, 184206996.932673,
         104811313.415469, 59636233.1659468, 33932217.7189535, 19306977.2888326,
         10985411.4198756, 6250551.925274, 3556480.30622314, 2023589.64772516,
         1151395.39932645, 655128.556859552, 372759.372031494, 212095.088792019,
         120679.264063932, 68664.8845004299, 39069.3993705461, 22229.9648252619,
         12648.5521685529, 7196.8567300115, 4094.91506238042, 2329.95181051537,
         1325.71136559011, 754.312006335461, 429.193426012878, 244.205309454865,
         138.949549437314, 79.060432109077, 44.9843266896944, 25.5954792269953,
         14.5634847750124, 8.28642772854684, 4.71486636345739, 2.68269579527972,
         1.52641796717523, 0.868511373751352, 0.494171336132383,
         0.281176869797423, 0.159985871960606, 0.0910298177991521,
         0.051794746792312, 0.0294705170255181, 0.0167683293681101,
         0.00954095476349993, 0.00542867543932386, 0.00308884359647748,
         0.00175751062485479, 0.001]
        )
test_res = [(1 - 1.59154943091895e-10j), (1 - 2.79716503482165e-10j),
            (1 - 4.91604726817137e-10j), (1 - 8.64000530609954e-10j),
            (1 - 1.51849011242717e-09j), (1 - 2.6687625063277e-09j),
            (1 - 4.69037846008504e-09j), (1 - 8.24338997818952e-09j),
            (1 - 1.44878454714896e-08j), (1 - 2.54625423473974e-08j),
            (1 - 4.47506887113659e-08j),
            (1.00000000000001 - 7.86498108797947e-08j),
            (1.00000000000002 - 1.38227878264057e-07j),
            (1.00000000000006 - 2.42936964700206e-07j),
            (1.00000000000018 - 4.26964296630533e-07j),
            (1.00000000000056 - 7.5039428776153e-07j),
            (1.00000000000174 - 1.31882593356968e-06j),
            (1.00000000000537 - 2.31785059057434e-06j),
            (1.00000000001659 - 4.07364703971464e-06j),
            (1.00000000005126 - 7.15947795395859e-06j),
            (1.00000000015833 - 1.25828585711486e-05j),
            (1.00000000048905 - 2.21145076225251e-05j),
            (1.0000000015106 - 3.8866482070316e-05j),
            (1.00000000466602 - 6.83082549737678e-05j),
            (1.0000000144126 - 0.000120052482711585j),
            (1.00000004451826 - 0.000210993507553708j),
            (1.00000013750994 - 0.000370823296817538j),
            (1.00000042474656 - 0.000651725696900933j),
            (1.00000131197454 - 0.00114541382054976j),
            (1.00000405247306 - 0.00201307144263008j),
            (1.00001251734949 - 0.00353796450020693j),
            (1.0000386631239 - 0.00621784762274577j),
            (1.00011941469859 - 0.0109270507787653j),
            (1.00036876134375 - 0.0191996187154482j),
            (1.00113816940071 - 0.0337175617612039j),
            (1.00350728883365 - 0.0591184214834285j),
            (1.01075467598615 - 0.103145590941064j),
            (1.03248963766796 - 0.177296534405386j),
            (1.09397755029893 - 0.291797481721045j),
            (1.2426489056175 - 0.428684515955647j),
            (1.49739637427516 - 0.499993221087131j),
            (1.75350281551825 - 0.430971370887114j),
            (1.90423387036101 - 0.294270246632169j),
            (1.9668492017852 - 0.179030228711573j),
            (1.98902144862154 - 0.104201836778865j),
            (1.99641915536696 - 0.05973292379208j),
            (1.99883790266327 - 0.034069735345405j),
            (1.99962348002419 - 0.0194004692859489j),
            (1.99987807221078 - 0.0110414185153842j),
            (1.99996052314088 - 0.00628293726675839j)]
test_res2 = [(1.00000892062058 - 8.92046142724053e-06j),
             (1.00001182616809 - 1.18258883788401e-05j),
             (1.00001567808544 - 1.56775938539714e-05j),
             (1.00002078461606 - 2.07837520904987e-05j),
             (1.00002755440172 - 2.75528833092262e-05j),
             (1.00003652918348 - 3.6526514916932e-05j),
             (1.00004842715362 - 4.84224636990012e-05j),
             (1.00006420042773 - 6.41921854018005e-05j),
             (1.00008511123619 - 8.50967508110213e-05j),
             (1.00011283293192 - 0.000112807475122324j),
             (1.00014958389737 - 0.000149539160071461j),
             (1.00019830506614 - 0.000198226447515664j),
             (1.00026289526438 - 0.000262757109164779j),
             (1.00034852320349 - 0.000348280435807445j),
             (1.00046204108712 - 0.000461614517189369j),
             (1.00061253292277 - 0.000611783447203753j),
             (1.00081204139692 - 0.000810724711129982j),
             (1.0010765314368 - 0.00107421857132859j),
             (1.00142716746481 - 0.00142310542877996j),
             (1.00189200631944 - 0.00188487388198023j),
             (1.00250824076825 - 0.00249572087381537j),
             (1.00332517187709 - 0.00330320395272228j),
             (1.00440814515977 - 0.00436961983849216j),
             (1.0058437587222 - 0.00577624420903761j),
             (1.00774674461038 - 0.00762853796680877j),
             (1.01026903840845 - 0.010062334679411j),
             (1.0136116818195 - 0.0132508197144433j),
             (1.01804032779693 - 0.0174117068349981j),
             (1.02390518064584 - 0.0228132773602136j),
             (1.03166606859146 - 0.0297766781309065j),
             (1.04192271965512 - 0.038669848081212j),
             (1.05544860972478 - 0.0498854984488797j),
             (1.07322293684808 - 0.0637919282567139j),
             (1.09644781212437 - 0.0806424301244203j),
             (1.12652519787447 - 0.10043032249987j),
             (1.16495146798862 - 0.122689715024282j),
             (1.21307566486261 - 0.146277359889675j),
             (1.27168455001045 - 0.169232437420713j),
             (1.34045872710921 - 0.188873415254491j),
             (1.41749696467935 - 0.202277188268905j),
             (1.49923740944068 - 0.207106369972467j),
             (1.5810227792264 - 0.202449506545794j),
             (1.65818479951715 - 0.189186164400969j),
             (1.72713418022154 - 0.169634276433853j),
             (1.78593797907923 - 0.146714366718482j),
             (1.83425121861222 - 0.123118064941343j),
             (1.87284536000222 - 0.100821385708608j),
             (1.90306336178452 - 0.0809818640774946j),
             (1.92640157028765 - 0.0640759708197357j),
             (1.94426498173332 - 0.0501169203046683j)]

test_circuits = [
    pytest.param('R-R-R', 3, id="Series"),
    pytest.param('R-p(R,R)', 1.5, id="Parallel"),
    pytest.param('R-p(R,R)-R', 2.5, id="Mix1"),
    pytest.param('R-p(R-R,R)-R', 2 + 2.0 / 3.0, id="Mix2"),
    pytest.param('R-p(R,C)', 1.0247045 - 0.1552231j, id="Randles"),
    pytest.param('R-p(R,CPE)', 1.2560427 - 0.1636903j, id="RandlesCPE"),
    ]

test_circuits2 = [
    pytest.param('R-R-R', 3, id="SeriesFreq"),
    pytest.param('R-p(R,R)', 1.5, id="ParallelFreq"),
    pytest.param('R-p(R,R)-R', 2.5, id="Mix1Freq"),
    pytest.param('R-p(R-R,R)-R', 2 + 2.0 / 3.0, id="Mix2Freq"),
    pytest.param('R-p(R,C)', test_res, id="RandlesFreq"),
    pytest.param('R-p(R,CPE)', test_res2, id="RandlesCPEFreq"),
    ]


@pytest.mark.parametrize(
        "circuit, expected",
        test_circuits
        )
def test_parse_circuit(circuit, expected):
    circuit_info, circuit_calc = parse_circuit(circuit)
    assert_array_almost_equal(
            circuit_calc(param_values, 1),
            expected
            )


@pytest.mark.parametrize(
        "circuit, expected",
        test_circuits2
        )
def test_parse_circuit_freq(circuit, expected):
    circuit_info, circuit_calc = parse_circuit(circuit)
    assert_array_almost_equal(
            circuit_calc(param_values, freq),
            expected
            )
